---
title: "Life Expectancy Analysis (Process)"
author: "Krissa Joy L. Tabornal and Jan Ira Villacarlos"
date: "6/1/2021"
output: pdf_document
---
```{r}
#packages
library(tidyverse)
library(readr)
library(ggplot2)
library(reshape2)
library(ggthemes)
```

#Data Reminders
1. Project gathered data from 2000-2015 from 193 countries
2. Must remove the missing data 
3. N/A usually from less known countries like Vanuatu, Tonga, Togo, Cabo Verde, etc
4. Could possible have 20 predicting variables
5. Predicting variables could be divided into categories: immunization related, mortality factors, economical factors, and social factors. 

#Possible Questions
1. What are the predicting factors that actually affects life expectancy? How did these factors change over the years?
2. Should a country having lower life expectancy (>65) increase its healthcare expenditure to improve average lifespan?
3. How does infant and adult mortality rates affects life expectancy?
4. What is the relationship between life expectancy and lifestyle habits? Which habits has a greater influence on life expectancy?
5. What is the influence of schooling or education on life expectancy?
6. What is the relationship between countries' health expenditure and life expectancy?
7. How does immunization affect life expectancy? What kind of immunizations have a greater influence?
8. Does economical factors and population affect life expectancy?
9. Is there a difference between the life expectancy of developed and developing countries?
10. What is the effect of BMI on life expectancy?
11. What is the relationship of immunization and under five deaths?
12. What is the relationship of thinness and under five deaths?

#Final questions
1. What are the predicting factors that actually affects life expectancy? How did these factors change over the years?
2. Should a country having lower life expectancy (>65) increase its healthcare expenditure to improve average lifespan?
3. What is the influence of schooling or education on life expectancy?
4. How does immunization affect life expectancy? What kind of immunizations have a greater influence?
5. Does economical factors and population affect life expectancy?
6. Is there a difference between the life expectancy of developed and developing countries?

#Information on the variables
1. country
2. year
3. status: developing or developed
4. life expectancy
5. adult mortality: rates of both sexes, probability of dying between 15 and 60 years per 1000 population
6. infant deaths: number of infant deaths per 1000 population
7. alcohol: recorded per capita consumption (liters of pure alcohol)
8. percentage expenditure: expenditure on health as % of GDP per capita (%)
9. Hepatitis B: coverage among 1-yr-olds (%)
10. Measles: number of reported cases per 1000 population
11. BMI: average BMI of entire population
12. under five deaths: number of under 5 deaths per 1000 population
13. Polio: coverage among 1-yr-olds (%)
14. total expenditure: general government expenditure on health as % of total government expenditure (%)
15. diphtheria: diphtheria tetanus toxoid and pertussis(DTP3) coverage among 1-yr-olds(%)
16. HIV/AIDS: deaths per 1000 live births (0-4yrs)
17. GDP: GDP per capita (in USD)
18. Population    
19. thinness 1-19 (age 10-19) (%)
20. thinness 5-9 years (age 5-9) (%)
21. income composition: human development index interms of income composition resources 
22. Schooling: number of years of schooling (yrs)

1. Checking data set structure
```{r}
# importing data set
life_expectancy <- read_csv("Life Expectancy Data.csv")

# checking data set
head(life_expectancy)
names(life_expectancy)
str(life_expectancy)
glimpse(life_expectancy)
dim(life_expectancy)

#check range of values and to see number of NAs
summary(life_expectancy)

#checking general visualizations of the data

#count of developed and developing countries
status <- life_expectancy %>%
  select(Year, Status) %>%
  group_by(Status, Year) %>%
  summarise(count = n()) 
#the status of countries per year did not change as much over the years

status <- life_expectancy %>%
  select(Year, Status) %>%
  group_by(Status, Year)

ggplot(data = status, aes(x = factor(Year), fill = Status)) + geom_bar()

#life expectancy per year 
ggplot(data = life_expectancy, aes(y = `Life expectancy`, x = factor(Year))) + geom_count()
#we can see that over the years countries are moving towards longer life expectancy, very few points left in 40-50s range 

#check correlations between variables
shapiro.test(life_expectancy$`Life expectancy`)
#nonnormal so must perform nonparametric correlation tests

#check possible correlations 
life_cor <- life_expectancy %>% 
              select(-Status, -Country, -Year)
life_cor <- cor(life_cor, use = "na.or.complete", method = "spearman")
life_cor

library(GGally)
ggpairs(life_cor)
#almost all variables have high correlation coefficients, except for Hepatitis B and Population. 

```

2. Tidying the dataset
```{r}

#round off numbers 
life_expectancy$`percentage expenditure` <- round(life_expectancy$`percentage expenditure`, digits = 3)
life_expectancy$GDP <- round(life_expectancy$GDP, digits = 3)

#inspect the years with data
unique(life_expectancy$Year)

#count how many countries have data for each year
life_expectancy %>%
  group_by(Year) %>%
  summarise(count = n())

#count how many unique countries
unique(life_expectancy$Country)

#inspect NA values
which(is.na(life_expectancy), arr.ind = TRUE) #find the indices
apply(is.na(life_expectancy), 2, which) #find the columns 

#make a separate dataframe without NA and see how it affects analysis
life_complete <- life_expectancy %>%
                    drop_na()
life_complete %>%
  group_by(Year) %>%
  summarise(count = n()) #discrepancies in year due to removed NA

unique(life_complete$Country) #removed 33 countries 

# creating a tidy dataframe for immunization related variables
immunization <- life_expectancy %>%
  select(Country, Year, Status,`Life expectancy`,`Hepatitis B`,Measles,Polio,Diphtheria) %>%
  remove_missing()

mortality <- life_expectancy %>%
  select(Country, Year, Status,`Life expectancy`,`Adult Mortality`,`infant deaths`,`under-five deaths`) %>%
  remove_missing()

economical <- life_expectancy %>%
  select(Country, Year, Status,`Life expectancy`,`percentage expenditure`,`Total expenditure`,GDP,`Income composition of resources`) %>%
  remove_missing()
  
social <- life_expectancy %>%
  select(Country, Year, Status,`Life expectancy`,Schooling) %>%
  remove_missing()

body <- life_expectancy %>%
  select(Country, Year, Status,`Life expectancy`,`thinness  1-19 years`,`thinness 5-9 years`,BMI) %>%
  remove_missing() 

alcohol <- life_expectancy %>%
  select(Country, Year, Status,`Life expectancy`,Alcohol) %>%
  remove_missing()
```

3. Methods to answer questions 
```{r}
#How does schooling after life expectancy?
#determine how many unique countries are part of the data 
unique(social$Country) 
#173 unique countries

#show summary of schooling years and life expectancy in developing and developed countries
developedS <- social %>%
  filter(Status == "Developed") %>%
  select(-Year, -Status)
summary(developedS)

developingS <- social %>%
  filter(Status == "Developing") %>%
  select(-Year, -Status)
summary(developingS)

ggplot(data = social, aes(x = Status, y = `Life expectancy`)) + geom_boxplot()  + stat_summary(fun = mean, geom = "point", size = 2, color = "red") 
ggplot(data = social, aes(x = Status, y = `Schooling`)) + geom_boxplot() + stat_summary(fun = mean, geom = "point", size = 2, color = "red") 
#shows that there is a difference in schooling years and life expectancy for developing and developed countries

#determine if there is a correlation and causation between schooling and life expectancy
cor.test(social$`Life expectancy`, social$Schooling)
#indicates high correlation so can be modeled using linear regression 

#visual the relationship using lm  
ggplot(data = social, aes(x = Schooling, y = `Life expectancy`)) + geom_point() + geom_smooth(method = "lm") + xlab("Schooling (yr)") + ylab("Life expectancy(yr)")

#test if there is causation
social_lm <- lm(`Life expectancy` ~ Schooling, data = social)
summary(social_lm)
#only 56.55% of the variability in life expectancy can be explained by years of schooling

```
  

4. Make interesting graphs
```{r}
ggplot(data = life_3yr, aes(x = `Total expenditure`, y = `Life expectancy`, color = Year)) +
  geom_point() + scale_color_gradient(low = "blue", high = "red")

ggplot(data = life_expectancy, aes(x = `GDP`, y = `Life expectancy`, color = Year)) +
  geom_point() + scale_color_gradient(low = "blue", high = "red")

ggplot(data = life_expectancy, aes(x = `Schooling`, y = `Life expectancy`, color = Year)) +
  geom_point() + scale_color_gradient(low = "blue", high = "red")

ggplot(data = life_expectancy, aes(x = `Schooling`, y = `Life expectancy`, color = Year)) +
  geom_point() + scale_color_gradient(low = "blue", high = "red")

ggplot(data = life_expectancy, aes(x = `Alcohol`, y = `Life expectancy`, color = Year)) +
  geom_point() + scale_color_gradient(low = "blue", high = "red")

ggplot(data = life_expectancy, aes(x = `BMI`, y = `Life expectancy`, color = Year)) +
  geom_point() + scale_color_gradient(low = "blue", high = "red")

ggplot(data = life_expectancy, aes(x = `Schooling`, y = `HIV/AIDS`, color = Year)) +
  geom_point() + scale_color_gradient(low = "blue", high = "red")

ggplot(data = life_expectancy, aes(x = `Total expenditure`, y = `infant deaths`, color = Year)) +
  geom_point() + scale_color_gradient(low = "blue", high = "red")

ggplot(data = life_expectancy, aes(x = `Total expenditure`, y = `Adult Mortality`, color = Year)) +
  geom_point() + scale_color_gradient(low = "blue", high = "red")

life_expectancy %>%
  select(Status, Year) %>% ggplot(aes(x = `Status`, color = `Year`)) +
  geom_bar() + scale_color_gradient(low = "blue", high = "red")

```

5. Modeling 
```{r}
#predict which variable is strongest predictor 
#establish correlation

```

Question 4: How does immunization affect life expectancy?
Immunization and life expectancy are positively correlated to a slight degree.
What kind of immunization have a great influence? Polio and Diphtheria

```{r}
# df for life expectancy and different kinds of immunization
expectancy_immunization <- immunization %>%
  select(`Life expectancy`,`Hepatitis B`,Polio,Diphtheria)

# compute correlation
immunization_cormat <- round(cor(expectancy_immunization),2)
immunization_cormat[upper.tri(immunization_cormat)] <- NA
head(immunization_cormat)

# reshape correlation
immunization_melted_cormat <- melt(immunization_cormat, na.rm = TRUE)
head(immunization_melted_cormat)

# plotting melted cormat
ggplot(immunization_melted_cormat, aes(x = Var1, y = Var2, fill = value)) + 
  scale_fill_gradient2(low = 'red', mid = 'yellow', high = 'green', limit = c(-1,1), midpoint = 0, name = "Pearson\nCorrelation") +
  geom_tile() + theme_clean()

# multiple linear regression model for immunization
plot(expectancy_immunization)
immunization_model <- lm(formula = `Life expectancy` ~ Polio + Diphtheria, data = expectancy_immunization)
summary(immunization_model)
```

